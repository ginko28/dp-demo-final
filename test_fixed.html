<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>边界测试 - 修复版</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        .test-container {
            width: 800px;
            height: 600px;
            background-image: url('images/background.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #000;
            position: relative;
            border: 3px solid red;
            margin: 20px auto;
        }
        
        .test-element {
            position: absolute;
            background-color: rgba(255, 0, 0, 0.7);
            border: 2px solid yellow;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
        }
        
        .info {
            max-width: 800px;
            margin: 0 auto;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
        }
        
        .dimensions {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="info">
        <h2>边界测试 - 修复版</h2>
        <p>红色边框显示容器边界，黄色边框显示测试元素。所有元素应该严格限制在背景图片范围内。</p>
        
        <div class="dimensions" id="dimensions">
            <h3>计算中的背景图片尺寸...</h3>
        </div>
        
        <div class="status" id="status">
            <h3>测试状态...</h3>
        </div>
        
        <button onclick="generateTestElements()">生成测试元素</button>
        <button onclick="clearElements()">清除元素</button>
    </div>
    
    <div class="test-container" id="container">
        <!-- 测试元素将在这里生成 -->
    </div>

    <script>
        let backgroundDimensions = null;
        let testElements = [];

        async function getBackgroundImageDimensions() {
            const container = document.querySelector('#container');
            const computedStyle = window.getComputedStyle(container);

            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;

            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const imageRatio = img.width / img.height;
                    const containerRatio = containerWidth / containerHeight;

                    let actualWidth, actualHeight, offsetX, offsetY;

                    if (containerRatio > imageRatio) {
                        actualHeight = containerHeight;
                        actualWidth = containerHeight * imageRatio;
                        offsetX = (containerWidth - actualWidth) / 2;
                        offsetY = 0;
                    } else {
                        actualWidth = containerWidth;
                        actualHeight = containerWidth / imageRatio;
                        offsetX = 0;
                        offsetY = (containerHeight - actualHeight) / 2;
                    }

                    resolve({
                        width: actualWidth,
                        height: actualHeight,
                        left: offsetX,
                        top: offsetY
                    });
                };
                img.src = computedStyle.backgroundImage.replace(/url\(['"]?(.*?)['"]?\)/i, '$1');
            });
        }

        async function generateRandomPosition() {
            const margin = 20;
            const componentWidth = Math.floor(Math.random() * 60) + 20; // 20-80px
            const componentHeight = Math.floor(Math.random() * 60) + 20; // 20-80px

            const imageLeft = backgroundDimensions.left;
            const imageTop = backgroundDimensions.top;
            const imageWidth = backgroundDimensions.width;
            const imageHeight = backgroundDimensions.height;

            const maxComponentWidth = Math.min(componentWidth, imageWidth - margin * 2);
            const maxComponentHeight = Math.min(componentHeight, imageHeight - margin * 2);

            const availableWidth = imageWidth - maxComponentWidth - (margin * 2);
            const availableHeight = imageHeight - maxComponentHeight - (margin * 2);

            if (availableWidth <= 0 || availableHeight <= 0) {
                return {
                    left: Math.round(imageLeft + margin),
                    top: Math.round(imageTop + margin),
                    width: Math.max(imageWidth - margin * 2, 20),
                    height: Math.max(imageHeight - margin * 2, 20)
                };
            }

            const randomX = Math.random() * availableWidth;
            const randomY = Math.random() * availableHeight;

            const finalLeft = Math.round(imageLeft + margin + randomX);
            const finalTop = Math.round(imageTop + margin + randomY);

            const rightEdge = finalLeft + maxComponentWidth;
            const bottomEdge = finalTop + maxComponentHeight;

            if (rightEdge > imageLeft + imageWidth || bottomEdge > imageTop + imageHeight) {
                return {
                    left: Math.round(imageLeft + margin),
                    top: Math.round(imageTop + margin),
                    width: maxComponentWidth,
                    height: maxComponentHeight
                };
            }

            return {
                left: finalLeft,
                top: finalTop,
                width: maxComponentWidth,
                height: maxComponentHeight
            };
        }

        function createTestElement(position, index) {
            const element = document.createElement('div');
            element.className = 'test-element';
            element.style.left = `${position.left}px`;
            element.style.top = `${position.top}px`;
            element.style.width = `${position.width}px`;
            element.style.height = `${position.height}px`;
            element.textContent = `元素${index}`;
            return element;
        }

        function validatePosition(position) {
            const imageLeft = backgroundDimensions.left;
            const imageTop = backgroundDimensions.top;
            const imageWidth = backgroundDimensions.width;
            const imageHeight = backgroundDimensions.height;

            const rightEdge = position.left + position.width;
            const bottomEdge = position.top + position.height;

            return {
                isValid: position.left >= imageLeft && 
                         position.top >= imageTop && 
                         rightEdge <= imageLeft + imageWidth && 
                         bottomEdge <= imageTop + imageHeight,
                details: {
                    left: position.left >= imageLeft,
                    top: position.top >= imageTop,
                    right: rightEdge <= imageLeft + imageWidth,
                    bottom: bottomEdge <= imageTop + imageHeight
                }
            };
        }

        async function generateTestElements() {
            const container = document.getElementById('container');
            container.innerHTML = '';
            testElements = [];

            let allValid = true;
            const results = [];

            for (let i = 0; i < 5; i++) {
                const position = await generateRandomPosition();
                const validation = validatePosition(position);
                
                results.push({
                    index: i + 1,
                    position: position,
                    validation: validation
                });

                if (!validation.isValid) {
                    allValid = false;
                }

                const element = createTestElement(position, i + 1);
                container.appendChild(element);
                testElements.push(element);
            }

            // 更新状态显示
            const statusDiv = document.getElementById('status');
            if (allValid) {
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '<h3>✅ 所有元素都在边界内！</h3>';
            } else {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<h3>❌ 发现超出边界的元素！</h3>';
            }

            // 显示详细信息
            let detailsHtml = '<h4>详细验证结果：</h4>';
            results.forEach(result => {
                const isValid = result.validation.isValid;
                const icon = isValid ? '✅' : '❌';
                detailsHtml += `<p>${icon} 元素${result.index}: ${isValid ? '在边界内' : '超出边界'}</p>`;
            });
            statusDiv.innerHTML += detailsHtml;
        }

        function clearElements() {
            const container = document.getElementById('container');
            container.innerHTML = '';
            testElements = [];
            document.getElementById('status').innerHTML = '<h3>已清除所有测试元素</h3>';
        }

        // 页面加载完成后初始化
        window.addEventListener('load', async () => {
            backgroundDimensions = await getBackgroundImageDimensions();
            
            document.getElementById('dimensions').innerHTML = `
                <h3>背景图片尺寸：</h3>
                <p>宽度: ${Math.round(backgroundDimensions.width)}px</p>
                <p>高度: ${Math.round(backgroundDimensions.height)}px</p>
                <p>左边距: ${Math.round(backgroundDimensions.left)}px</p>
                <p>上边距: ${Math.round(backgroundDimensions.top)}px</p>
            `;
            
            document.getElementById('status').innerHTML = '<h3>准备就绪，点击"生成测试元素"开始测试</h3>';
        });
    </script>
</body>
</html> 